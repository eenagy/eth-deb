#!/bin/bash
set -e

. /usr/share/debconf/confmodule

declare -A CONFIG

adduser --system --quiet --group --home "/var/lib/eth-node-prysm-service-sepolia" eth-node-prysm-service-sepolia

usermod -a -G eth-node-sepolia eth-node-prysm-service-sepolia
db_get eth-node-prysm-service-sepolia/datadir
CONFIG["eth-node-prysm-service-sepolia/datadir"]="$RET"
db_get eth-node-prysm-service-sepolia/execution-endpoint
CONFIG["eth-node-prysm-service-sepolia/execution-endpoint"]="$RET"
db_get eth-node-prysm-service-sepolia/jwt-secret
CONFIG["eth-node-prysm-service-sepolia/jwt-secret"]="$RET"
db_get eth-node-prysm-service-sepolia/genesis-state
CONFIG["eth-node-prysm-service-sepolia/genesis-state"]="$RET"
db_get eth-node-prysm-service-sepolia/checkpoint-sync-url
CONFIG["eth-node-prysm-service-sepolia/checkpoint-sync-url"]="$RET"
db_get eth-node-prysm-service-sepolia/genesis-beacon-api-url
CONFIG["eth-node-prysm-service-sepolia/genesis-beacon-api-url"]="$RET"
mkdir -p "`dirname "/etc/eth-node-prysm-service-sepolia/config.yaml"`"
echo -n > "/etc/eth-node-prysm-service-sepolia/config.yaml"
echo '# Automtically generated - DO NOT MODIFY!' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
chgrp "eth-node-prysm-service-sepolia" "/etc/eth-node-prysm-service-sepolia/config.yaml"
chmod 640 /etc/eth-node-prysm-service-sepolia/config.yaml
RET="${CONFIG[eth-node-prysm-service-sepolia/checkpoint-sync-url]}"
echo >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
echo -n "checkpoint-sync-url: \"" >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
if [ $(cat << EOF | wc -c
$RET
EOF
) -gt 1 ]; then
cat << EOF | perl -pe 'chomp if eof' | sed -e 's/\\/\\\\/' -e 's/"/\\"/' | awk 1 ORS='\n' | sed 's/$/"/' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
$RET
EOF
else
echo '"' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
fi

RET="${CONFIG[eth-node-prysm-service-sepolia/datadir]}"
echo >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
echo -n "datadir: \"" >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
if [ $(cat << EOF | wc -c
$RET
EOF
) -gt 1 ]; then
cat << EOF | perl -pe 'chomp if eof' | sed -e 's/\\/\\\\/' -e 's/"/\\"/' | awk 1 ORS='\n' | sed 's/$/"/' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
$RET
EOF
else
echo '"' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
fi

RET="${CONFIG[eth-node-prysm-service-sepolia/execution-endpoint]}"
echo >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
echo -n "execution-endpoint: \"" >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
if [ $(cat << EOF | wc -c
$RET
EOF
) -gt 1 ]; then
cat << EOF | perl -pe 'chomp if eof' | sed -e 's/\\/\\\\/' -e 's/"/\\"/' | awk 1 ORS='\n' | sed 's/$/"/' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
$RET
EOF
else
echo '"' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
fi

RET="${CONFIG[eth-node-prysm-service-sepolia/genesis-beacon-api-url]}"
echo >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
echo -n "genesis-beacon-api-url: \"" >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
if [ $(cat << EOF | wc -c
$RET
EOF
) -gt 1 ]; then
cat << EOF | perl -pe 'chomp if eof' | sed -e 's/\\/\\\\/' -e 's/"/\\"/' | awk 1 ORS='\n' | sed 's/$/"/' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
$RET
EOF
else
echo '"' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
fi

RET="${CONFIG[eth-node-prysm-service-sepolia/genesis-state]}"
echo >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
echo -n "genesis-state: \"" >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
if [ $(cat << EOF | wc -c
$RET
EOF
) -gt 1 ]; then
cat << EOF | perl -pe 'chomp if eof' | sed -e 's/\\/\\\\/' -e 's/"/\\"/' | awk 1 ORS='\n' | sed 's/$/"/' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
$RET
EOF
else
echo '"' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
fi

RET="${CONFIG[eth-node-prysm-service-sepolia/jwt-secret]}"
echo >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
echo -n "jwt-secret: \"" >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
if [ $(cat << EOF | wc -c
$RET
EOF
) -gt 1 ]; then
cat << EOF | perl -pe 'chomp if eof' | sed -e 's/\\/\\\\/' -e 's/"/\\"/' | awk 1 ORS='\n' | sed 's/$/"/' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
$RET
EOF
else
echo '"' >> "/etc/eth-node-prysm-service-sepolia/config.yaml"
fi

dpkg-trigger --no-await "`realpath "/etc/eth-node-prysm-service-sepolia/config.yaml"`"
if [ "$1" = triggered -a "$service_was_running" '!=' 0 ];
then
	deb-systemd-invoke restart eth-node-prysm-service-sepolia
fi

if [ "$1" '!=' triggered ];
then
	dpkg-trigger eth-node-prysm-service-sepolia-config-changed

fi
#DEBHELPER#

exit 0
