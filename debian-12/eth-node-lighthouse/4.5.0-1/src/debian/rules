#!/usr/bin/make -f
export CARGO=$(HOME)/.cargo
export PATH:=$(PATH):$(CARGO)/bin
# same as CROSS_FEATURES, but packaging don't use cross
# cross relies on rustup, which pkg-builder doesn't use
# cross uses dockerized environment for building, which we don't need
# pkg-builder uses chroot instead of docker, chroot is much more lightweight
# chroot is the debian way
export FEATURES=gnosis,slasher-lmdb,slasher-mdbx,jemalloc
export XDG_RUNTIME_DIR=/tmp/user/112
export DOCKER_HOST:=unix:///$(XDG_RUNTIME_DIR)/docker.sock
export IMAGE_NAME=fedora-coreos-39.20240322.3.1-qemu.x86_64.qcow2.xz
export IMAGE_URL:=https://builds.coreos.fedoraproject.org/prod/streams/stable/builds/39.20240322.3.1/x86_64/$(IMAGE_NAME)

%:
	dh $@

docker_setup:
	#eval "$$(ssh-agent -s)"
	# curl $(IMAGE_URL) --output $(IMAGE_NAME)
	# xz -d $(IMAGE_NAME)
	# qemu-system-x86_64 -m 2048M -drive file=fedora-coreos-39.20240322.3.1-qemu.x86_64.qcow2,format=qcow2 -nographic
	# podman machine init --rootful=false
	# podman machine start
	# mkdir -p /tmp/user/112
	# mkdir -p /var/lib/sbuild/.local/share/containers
	# strace podman --storage-driver=vfs info --debug
	cat /etc/subuid
	cat /etc/subgid
	cat /proc/sys/user/max_user_namespaces
	#strace podman info
	podman run --security-opt label=disable hello-world
	# ls -l /tmp/user
	# export SKIP_IPTABLES=1 && curl -fsSL https://get.docker.com/rootless | sh
	# dockerd-rootless.sh --experimental --storage-driver vfs seccomp=unconfined apparmor=unconfined systempaths=unconfined

override_dh_auto_build: docker_setup 
	dh_auto_build

override_dh_auto_test:
	# # Install additional test dependency
	# cd /tmp && curl -s -L https://github.com/foundry-rs/foundry/releases/download/nightly-ca67d15f4abd46394b324c50e21e66f306a1162d/foundry_nightly_linux_amd64.tar.gz -o foundry_nightly_linux_amd64.tar.gz
	# cd /tmp && tar xvf foundry_nightly_linux_amd64.tar.gz 
	# cp /tmp/anvil $(HOME)/.cargo/bin
	# anvil --version # check if it correctly installed
	# make -j1 test-release

override_dh_auto_install:
	# This relies on make install script
	# if there is no install script, you have define your own rules
	dh_auto_install -- prefix=/usr

override_dh_auto_clean:
	# on ubuntu clean fails, before dependency installation
	# on bookworm clean succeeds, even if dependency is not installed
	-make -j1 clean
